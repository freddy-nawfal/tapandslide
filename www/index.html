<!DOCTYPE html>
<html>
 
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">

        <script src="js/phaser.js"></script>
        <link rel="stylesheet" href="css/main.css" type="text/css">
    </head>
 
    <body ng-app="main">
    	<div id="menu">
            <img src="assets/logo.png" width="100%">
            <div id="buttons">
                <button onclick="$(this).hide(); $('#searching').show(); playRanked();" class="menuBtn" id="ranked">Ranked</button>
                <button class="menuBtn" style="display: none;" id="searching" onclick="abandonSearch();">Searching <img src="assets/loader.gif" width="16px"></button>
                <button onclick="playPractice()" class="menuBtn">Practice</button>
            </div>

    	</div>
    	<div id="msg" style="display: none"></div>
		<div id="game"></div>


		<script type="text/javascript" src="js/jquery.min.js"></script>
        <script type="text/javascript" src="js/socket.io.js"></script>
		<script type="text/javascript" src="js/notify.js"></script>
        <script type="text/javascript" src="js/multiplayer/gHandlers.js"></script>
		<script type="text/javascript" src="js/multiplayer/eHandlers.js"></script>
		<script src="cordova.js"></script>
		<script type="text/javascript" src="js/utilities.js"></script>
		<script src="js/game.js"></script>
    	<script type="text/javascript">
    		
    		document.addEventListener('deviceready', Startup, false);

    		var socket;
            var searching = false;
            var myID = null;

    		function Startup(){
				// INIT SOCKET
				socket = io.connect('http://192.168.1.24:8000');

                $("#game").hide();
                $("#menu").hide();
                info("Connecting to servers");
                loadErrorHandlers();

                waitForConnection();
    		}

            function waitForConnection(){
                socket.on('connected', function(data){
                    myID = data;
                    hideNotification(true);
                    $("#menu").show();
                });
            }

            function mainMenu(){
                $("#menu").show();
                $("#game").hide();
            }

    		function playRanked(){
                searching = true;


    			gameHandlers.out.search("ranked");

                loadGameHandlers();
    		}
            function abandonSearch(){
                info("You left the matchmaking", 2);
                gameHandlers.out.abandonSearch();
                $("#searching").hide();
                $("#ranked").show();
            }


    		function loadGameHandlers(){
    			socket.on('level', gameHandlers.in.loadLevel);
                socket.on("joinedRoom", gameHandlers.in.joinedRoom);
                socket.on('opponentLeft', gameHandlers.in.opponentLeft);
                socket.on('progressionInfo', gameHandlers.in.progressionInfo);
                socket.on('winner', gameHandlers.in.winner);
    		}
            function loadErrorHandlers(){
                socket.on('connect_error', errors.connect_error);
                socket.on('connect_timeout', errors.connect_timeout);
                socket.on('reconnect_attempt', errors.reconnect_attempt);
                socket.on('reconnect_error', errors.reconnect_error);
                socket.on('reconnect_failed', errors.reconnect_failed);
                socket.on('reconnect', errors.reconnect);
            }

            function playPractice(){
                $("#menu").hide();

                var level = generatePracticeLevel(50);
                info("Generating practice level");

                if(game)game.destroy();

                launch("practice",level);
                setTimeout(function(){
                    if(searching){
                        info("Searching for an opponent...");
                    }
                    else{
                        hideNotification();
                    }
                    $("#game").show();
                }, 1000);
            }

    	</script>

        
    </body>
 
</html>