<!DOCTYPE html>
<html>
 
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, user-scalable=no">

        <script src="js/phaser.js"></script>
        <link rel="stylesheet" href="css/main.css" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600,800,900" rel="stylesheet" type="text/css">
    </head>
 
    <body ng-app="main">
    	<div id="menu">

            <div style="text-align: right;">
                <div id="p1" style="font-size: 2px; position: absolute; z-index: 3; display:inline-block;"></div>
            </div>
             


            <img src="assets/logo.png" width="100%">
            <div id="buttons">
                <button onclick="$(this).hide(); $('#searching').show(); playRanked();" class="menuBtn" id="ranked">Ranked</button>
                <button class="menuBtn" style="display: none;" id="searching" onclick="abandonSearch();">Searching <img src="assets/loader.gif" width="16px"></button>
                <button onclick="playPractice()" class="menuBtn">Practice</button>
            </div>

    	</div>
        <div id="readyMenu" style="display: none;">
            <button onclick="$(this).css('background','#20e837'); isReady();" class="menuBtn" id="ready">Ready</button>
            <div id="timer"></div>
        </div>
    	<div id="msg" style="display: none"></div>

        <div id="inGameLoader" style="display: none;"><img src="assets/loader.gif" width="20px"></div>
    <!--
        <div id="sideMenu" style="display: none;"> 
            <button onclick="leave()" id="leaveBtn"><-</button> 

            <div style="text-align: right;
            z-index: 3;
            position: absolute;
            left: 10vw;
            top: 5px;">
                <div id="player1" style="font-size: 2px; position: absolute; z-index: 4; display:inline-block;"></div>
            </div>

            <div style="text-align: right;
            z-index: 3;
            position: absolute;
            left: 90vw;
            top: 5px;">
                <div id="player2" style="font-size: 2px; position: absolute; z-index: 4; display:inline-block;"></div>
            </div>
        </div>
    -->

        <div id="progressBars" style="display: none;">*
            <div id="player1ProgressBar" 
                style="text-align: right;
                width: 15vw;
                height: 15vw;
                z-index: 3;
                position: absolute;
                left: 10vw;
                top: 5vw;">
            </div>
            <div id="player2ProgressBar" 
                style="text-align: right;
                width: 15vw;
                height: 15vw;
                z-index: 3;
                position: absolute;
                right: 10vw;
                top: 5vw;">
            </div>
        </div>

		<div id="game"></div>


        <script type="text/javascript" src="js/jquery.min.js"></script>
		<script type="text/javascript" src="js/radialprogress.js"></script>
        <script type="text/javascript" src="js/socket.io.js"></script>
		<script type="text/javascript" src="js/notify.js"></script>
        <script type="text/javascript" src="js/multiplayer/gHandlers.js"></script>
		<script type="text/javascript" src="js/multiplayer/eHandlers.js"></script>
        <script type="text/javascript" src="js/progressbar.min.js"></script>
		<script src="cordova.js"></script>
		<script type="text/javascript" src="js/utilities.js"></script>
		<script src="js/game.js"></script>
    	<script type="text/javascript">
/*           
            var p1=new RadialProgress(document.getElementById("player1"), {
                colorBg:"rgba(0,0,0,0)",
                colorFg:"#5fadbe",
                thick:5,
                noPercentage: true
            });
            var p2=new RadialProgress(document.getElementById("player2"), {
                colorBg:"rgba(0,0,0,0)",
                colorFg:"#cc5858",
                thick:5,
                noPercentage: true
            });
            p1.setValue(0);
            p2.setValue(0);
*/   		

    		document.addEventListener('deviceready', Startup, false);

    		var socket;
            var searching = false;
            var myID = null;

    		function Startup(){
				// INIT SOCKET
				socket = io.connect('http://localhost:8000');

                $("#game").hide();
                $("#menu").hide();
                info("Connecting to servers");
                loadErrorHandlers();

                waitForConnection();
                loadGameHandlers();
    		}

            function waitForConnection(){
                socket.on('connected', function(data){
                    myID = data;
                    hideNotification(true);
                    $("#menu").show();
                });
            }

            function leave(){
                gameHandlers.out.forceLeave();
                mainMenu();
            }

            function mainMenu(){
                $("#readyMenu").hide();
                $("#inGameLoader").hide();
                $("#menu").show();
                //$("#sideMenu").hide();
                $("#progressBars").hide();
                $("#game").hide();
                //p1.setValue(0);
                //p2.setValue(0);
                if(game){
                    console.log("destroying game");
                    game.destroy(true, true);
                    game = null;
                    $("#game").html("");
                }
                clearInterval(timerInterval);
            }

    		function playRanked(){
                searching = true;

    			gameHandlers.out.search("ranked");
    		}
            function abandonSearch(){
                info("You left the matchmaking", 2);
                gameHandlers.out.abandonSearch();
                $("#searching").hide();
                $("#ranked").show();
            }

            function isReady(){
                info("Waiting for opponent "+'<img src="assets/loader.gif" width="14px">');
                clearInterval(timerInterval);
                gameHandlers.out.readyLaunch();
                $("#readyMenu").hide();
            }


    		function loadGameHandlers(){
    			socket.on('level', gameHandlers.in.loadLevel);
                socket.on("joinedRoom", gameHandlers.in.joinedRoom);
                socket.on("gameStart", gameHandlers.in.gameStart);
                socket.on('opponentLeft', gameHandlers.in.opponentLeft);
                socket.on('progressionInfo', gameHandlers.in.progressionInfo);
                socket.on('winner', gameHandlers.in.winner);
                socket.on('loser', gameHandlers.in.loser);
    		}
            function loadErrorHandlers(){
                socket.on('connect_error', errors.connect_error);
                socket.on('connect_timeout', errors.connect_timeout);
                socket.on('reconnect_attempt', errors.reconnect_attempt);
                socket.on('reconnect_error', errors.reconnect_error);
                socket.on('reconnect_failed', errors.reconnect_failed);
                socket.on('reconnect', errors.reconnect);
            }

            function playPractice(){
                $("#menu").hide();

                var level = generatePracticeLevel(50);
                info("Generating practice level", 2);

                if(game){
                    console.log("destroying game");
                    game.destroy(true, true);
                    game = null;
                    $("#game").html("");
                }

                launch("practice",level);
                setTimeout(function(){
                    if(searching){
                        $("#inGameLoader").show();
                    }
                    $("#game").show();
                    hideNotification();
                }, 1000);
            }




            var timerInterval;
            function startTimer(duration, display, after) {
                var timer = duration, minutes, seconds;
                timerInterval = setInterval(function () {
                    minutes = parseInt(timer / 60, 10)
                    seconds = parseInt(timer % 60, 10);

                    minutes = minutes < 10 ? "0" + minutes : minutes;
                    seconds = seconds < 10 ? "0" + seconds : seconds;

                    display.html(minutes + ":" + seconds);

                    if (--timer < 0) {
                        clearInterval(timerInterval);
                        after();
                    }
                }, 1000);
            }

    	</script>

        
    </body>
 
</html>